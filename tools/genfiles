#!/bin/bash

separatename () {
echo $1 | awk -F / '{ printf ($2) }'
}

fileentry () {
echo -ne "\t\tdata\t0x"${1:0:1}${1:2:2}",\t"
if [ -z $2 ] ; then pth="" ; else pth="_"$2 ; fi

case ${1:0:1} in 
    ("7") echo "DF"$pth"_"$1 ;;
    ("6") echo "EF"$pth"_"$1 ;;
    ("5") echo "DF"$pth"_"$1 ;;
    ("4") echo "EF"$pth"_"$1 ;;
    ("3") echo "DF"$pth"_"$1 ;;
    ("2") echo "EF"$pth"_"$1 ;;
esac
}

makedir () { (
cd $1
sname=`separatename $1`

if [ -z "$3" ] ; then
# Masterfile workaround
current="3F00"
echo "DF_3F00"
echo -e "\t\t; Parent"
echo -e "\t\tdata\t0x300"",\tDF_3F00"
else
current=$3"_"$sname
echo "DF_"$current
echo -e "\t\t; Parent"
parent=`echo $3 | awk -F "_" '{ print ($NF)}'`
fileentry $parent $4
fi

echo -e "\t\t; Dedicated files"
find . -mindepth 1 -maxdepth 1 -type d | { while read dir ; do
fileentry `separatename $dir` $current
done
}

echo -e "\t\t; Elementary files"
find . -mindepth 1 -maxdepth 1 -type f | ( while read f ; do
fileentry `separatename $f` $current
done
)
echo -e "\t\t; Finished"
echo -e "\t\tdata\t0x00"

# Process files
find . -mindepth 1 -maxdepth 1 -type f | ( while read fil ; do
file=`separatename $fil`
echo -e "\nEF_"$current"_"$file
echo -e "#include\t\"src/files/"`echo $current | sed 'y\_\/\'`"/"$file"\""
done
)

# Process next directories
find . -mindepth 1 -maxdepth 1 -type d | ( while read dir ; do
echo
if [ -z "$3" ] ; then
    makedir $dir $sname $sname
else
    makedir $dir $sname $3"_"$sname $3
fi
done
)

cd ..

) }

echo "; This file is generated by tools/genfiles script"
echo

# Launch it...
cd src/files
makedir ./3F00 3F00
cd ../..
